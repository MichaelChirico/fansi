```{r}
old.hook <- knitr::knit_hooks$get("output")
new.hook <- function(x, options){

  # If the output has SGR in it, then:
  if(any(fansi::has_sgr(x))) {
    code_block(                  # add <PRE> & <CODE> HTML tags
      fansi::sgr_to_html(        # convert SGR to HTML
        x = html_esc(x)          # escape HTML special chars in input
    ) )
  }
  # If output doesn't have SGR, then:
  else {
    old.hook(x, options)         # use the default output hook
  }
}
knitr::knit_hooks$set(output = new.hook)
```
