```{r}
html_esc <- function(x) {
  x <- gsub("<", "&lt;", x)
  x <- gsub(">", "&gt;", x)
}
old.hook <- knitr::knit_hooks$get("output")
new.hook <- function(x, options){
  if(isTRUE(options[['fansi']])) {
    paste0(
      "<pre class=\"r-fansi-output\"><code>",
      fansi::sgr_to_html(x = html_esc(x)),
      "</code></pre>"
    )
  } else {
    old.hook(x, options)
  }
}
knitr::knit_hooks$set(output = new.hook)
```
