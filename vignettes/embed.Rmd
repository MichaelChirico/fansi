---
title: "ANSI CSI SGR Text in Vignettes"
author: "Brodie Gaslam"
output:
    rmarkdown::html_vignette:
        toc: true
        css: styles.css
mathjax: local
vignette: >
  %\VignetteIndexEntry{Embed Diffs in R Markdown}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r echo=FALSE}
library(fansi)
```

## Introduction

Over the past few years color has been gaining traction in the R terminal.
Gábor Csárdi's [crayon]() made it easy to format text with [ANSI CSI SGR
sequences]().  Unfortunately these sequences are not recognized by web browser,
and instead end up rendering weirdly, as in this example:

```{r}
sgr.string <- c(
  "\033[43;34mday > night\033[0m",
  "\033[44;33mdawn < dusk\033[0m",
  "boom boom"
)
writeLines(sgr.string)  # this should output in yellow and blue
```
Instead of the expected:

```{r echo=FALSE}
old.hooks <- fansi::fansi_knit_hooks(knitr::knit_hooks)
writeLines(sgr.string)
do.call(knitr::knit_hooks[['set']], old.hooks)
```

## Output as HTML

Among other things `fansi` provides the `sgr_to_html` function which converts
the ANSI CSI SGR sequences into HTML markup:

```{r}
fansi::sgr_to_html(sgr.string)
```

This however is insufficient as `knitr` / `rmarkdown`  / `pandoc` escape all the
HTML markup so the browser does not interpret.

## Knitr Integration

Thankfully Yihui Xie built a lot of flexibility into `knitr` so we can override
the existing output handler

`knitr` allows us to set hooks that process the output of evaluated R code
chunks:

```{r eval=FALSE}
knitr::knit_hooks$set(output = FUN)
```

`FUN` is a function that takes the raw screen output (captured as text) produced
by the R code chunk and modifies it for further processing by `pandoc` into the
final output.

`fansi` provides `fansi_knit_hooks` which automatically sets the hooks that
process the ANSI CSI SGR into HTML for you provided you pass it the
`knitr::knit_hooks` object:

```{r comment="", results='asis'}
fansi::fansi_knit_hooks(knitr::knit_hooks)
```

See `?fansi::fansi_knit_hooks` for details.

Now, we get the desired output:

```{r}
writeLines(sgr.string)
```

## Styling

## Appendix

These are the helper functions we used in our knit hook.  A couple of notes;

* You should use a proper HTML escape function such as `htmltools::htmlEscape`;
  we do not do so here to avoid an additional dependency.
* As far as we can tell `pandoc` when outputting chunk output uses unclassed
  &lt;PRE&gt; and &lt;CODE&gt; HTML tags.  In the future this might change,
  which may cause code output with SGR in it to be formatted differently than
  code output without it.

blay blah blah

