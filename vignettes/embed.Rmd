---
title: "ANSI CSI SGR in Rmarkdown"
author: "Brodie Gaslam"
output:
    rmarkdown::html_vignette:
        toc: true
        css: styles.css
mathjax: local
vignette: >
  %\VignetteIndexEntry{ANSI CSI SGR in Rmarkdown}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r echo=FALSE}
library(fansi)
```

## ANSI CSI SGR to HTML

Over the past few years color has been gaining traction in the R terminal.
Gábor Csárdi's [crayon]() made it easy to format text with [ANSI CSI SGR
sequences]().  Unfortunately these sequences are not recognized by web browsers,
and instead end up rendering weirdly:

```{r}
sgr.string <- c(
  "\033[43;34mday > night\033[0m",
  "\033[44;33mdawn < dusk\033[0m"
)
writeLines(sgr.string)
```

`fansi` provides the `sgr_to_html` function which converts the ANSI CSI SGR
sequences into HTML markup:

```{r}
fansi::sgr_to_html(sgr.string)
```

As is obvious from the above output this on its own is insufficient.
We need to instruct `knitr` / `rmarkdown` to interpret the HTML as HTML.

## Knitr Hooks

Thankfully Yihui Xie built a lot of flexibility into `knitr` so we can override
the existing output handler with:

```{r eval=FALSE}
knitr::knit_hooks$set(output = FUN)
```

Any output from an R hunk will be passed to `FUN`, and the return value of that
will be passed on to `pandoc` for final processing.

`fansi` takes advantage of this in `set_knit_hooks`.  It automatically sets
the hooks that process the ANSI CSI SGR, and also outputs some CSS styles.  You
should call it with the:

  * Chunk option `results` set to "asis".
  * Chunk option `comments` set to "".
  * The `knitr::knit_hooks` object as an argument (this allows `fansi` to avoid
    a run-time dependency on `knitr`).

The corresponding `rmarkdown` hunk should look as follows:

    ```{r comment="", results='asis'}
    old.hooks <- fansi::set_knit_hooks(knitr::knit_hooks)
    ```

```{r comment='', results='asis', echo=FALSE}
old.hooks <- fansi::set_knit_hooks(knitr::knit_hooks)
```
Now, we get the desired output:

```{r}
writeLines(sgr.string)
```

We can also set hooks for the other types of outputs, and add some additional
CSS styles.

    ```{r comment="", results='asis'}
    styles <- c(
      getOption('fansi.style'),  # default style
      "PRE.fansi CODE {background-color: transparent;}",
      "PRE.fansi-error {background-color: #DD5555;}",
      "PRE.fansi-warning {background-color: #DDDD55;}",
      "PRE.fansi-message {background-color: #EEEEEE;}"
    )
    old.hooks <- c(
      old.hooks,
      fansi::set_knit_hooks(
        knitr::knit_hooks,
        which=c('warning', 'error', 'message'),
        style=styles
    ) )
    ```
```{r comment="", results='asis', echo=FALSE}
styles <- c(
  getOption('fansi.style'),  # default style
  "PRE.fansi CODE {background-color: transparent;}",
  "PRE.fansi-error {background-color: #DD5555;}",
  "PRE.fansi-warning {background-color: #DDDD55;}",
  "PRE.fansi-message {background-color: #EEEEEE;}"
)
old.hooks <- c(
  old.hooks,
  fansi::set_knit_hooks(
    knitr::knit_hooks,
    which=c('warning', 'error', 'message'),
    style=styles
) )
```
```{r error=TRUE}
message(paste0(sgr.string, collapse="\n"))
warning(paste0(c("", sgr.string), collapse="\n"))
stop(paste0(c("", sgr.string), collapse="\n"))
```

You can restore the old hooks at any time in your document with:

```{r}
do.call(knitr::knit_hooks$set, old.hooks)
writeLines(sgr.string)
```

See `?fansi::set_knit_hooks` for details.

## Crayon

If you use `crayon` to generate your ANSI CSI SGR style strings you may need to
set `options(crayon.enabled=TRUE)`, as in some cases `crayon` suppresses the
markdown if it think it is not outputting to a ANSI CSI SGR aware terminal.

